# =============================================================================
# LA Land Wholesale - Production Docker Compose
# =============================================================================
version: "3.9"

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL with PostGIS
  # ---------------------------------------------------------------------------
  db:
    image: postgis/postgis:16-3.4
    container_name: la_land_db_prod
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-la_land}
      POSTGRES_USER: ${POSTGRES_USER:-la_land}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-la_land} -d ${POSTGRES_DB:-la_land}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - la_land_network
    deploy:
      resources:
        limits:
          memory: 2G

  # ---------------------------------------------------------------------------
  # FastAPI Backend
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: la_land_api_prod
    restart: unless-stopped
    command: >
      uvicorn api.app:app
      --host 0.0.0.0
      --port 8000
      --workers 4
      --log-level info
      --access-log
    environment:
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-la_land}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-la_land}
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER}
      TWILIO_MESSAGING_SERVICE_SID: ${TWILIO_MESSAGING_SERVICE_SID}
      DRY_RUN: ${DRY_RUN:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: production
      MAX_SMS_PER_DAY: ${MAX_SMS_PER_DAY:-50}
      MIN_MOTIVATION_SCORE: ${MIN_MOTIVATION_SCORE:-60}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - la_land_network
    deploy:
      resources:
        limits:
          memory: 1G

  # ---------------------------------------------------------------------------
  # Streamlit Dashboard
  # ---------------------------------------------------------------------------
  dashboard:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: la_land_dashboard_prod
    restart: unless-stopped
    command: >
      streamlit run src/dashboard/streamlit_app.py
      --server.port 8501
      --server.address 0.0.0.0
      --server.headless true
      --browser.gatherUsageStats false
    environment:
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-la_land}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-la_land}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER}
      DRY_RUN: ${DRY_RUN:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: production
      API_BASE_URL: http://api:8000
    depends_on:
      - api
    networks:
      - la_land_network
    deploy:
      resources:
        limits:
          memory: 512M

  # ---------------------------------------------------------------------------
  # Background Scheduler
  # ---------------------------------------------------------------------------
  scheduler:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: la_land_scheduler_prod
    restart: unless-stopped
    command: python -m scheduler.runner
    environment:
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-la_land}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-la_land}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER}
      TWILIO_MESSAGING_SERVICE_SID: ${TWILIO_MESSAGING_SERVICE_SID}
      DRY_RUN: ${DRY_RUN:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: production
      MAX_SMS_PER_DAY: ${MAX_SMS_PER_DAY:-50}
      SMS_BATCH_SIZE: ${SMS_BATCH_SIZE:-25}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - la_land_network
    deploy:
      resources:
        limits:
          memory: 512M

  # ---------------------------------------------------------------------------
  # Database Migrations (run once)
  # ---------------------------------------------------------------------------
  migrations:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: la_land_migrations
    command: alembic upgrade head
    environment:
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-la_land}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-la_land}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - la_land_network
    restart: "no"

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:1.25-alpine
    container_name: la_land_nginx_prod
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
      - dashboard
    networks:
      - la_land_network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  la_land_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
